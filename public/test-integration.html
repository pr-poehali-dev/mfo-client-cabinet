<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f1419 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e5e7eb;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 15px;
            font-size: 1.3rem;
            color: #667eea;
        }

        .test-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .test-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }

        .test-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .status-pending {
            background: rgba(234, 179, 8, 0.2);
            color: #facc15;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .test-result {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            color: #9ca3af;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #d1d5db;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
        }

        .summary {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .summary-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π AmoCRM & SMS</h1>

        <div class="summary" id="summary">
            <div class="summary-title">–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalTests">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #86efac" id="passedTests">0</div>
                    <div class="stat-label">–£—Å–ø–µ—à–Ω–æ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #fca5a5" id="failedTests">0</div>
                    <div class="stat-label">–û—à–∏–±–æ–∫</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h2>
            <div class="input-group">
                <label>–¢–µ—Å—Ç–æ–≤—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                <input type="tel" id="testPhone" placeholder="+7 (999) 123-45-67" value="79991234567">
            </div>
            <button class="btn" onclick="runAllTests()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
        </div>

        <div class="section">
            <h2>üîó –¢–µ—Å—Ç 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AmoCRM OAuth</h2>
            <div class="test-item" id="test-oauth">
                <div class="test-name">–ü–æ–ª—É—á–µ–Ω–∏–µ access_token —á–µ—Ä–µ–∑ refresh_token</div>
                <span class="test-status status-pending">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                <div class="test-result" id="result-oauth">–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"</div>
            </div>
        </div>

        <div class="section">
            <h2>üë§ –¢–µ—Å—Ç 2: –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ AmoCRM</h2>
            <div class="test-item" id="test-contact">
                <div class="test-name">–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
                <span class="test-status status-pending">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                <div class="test-result" id="result-contact">–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"</div>
            </div>
        </div>

        <div class="section">
            <h2>üì± –¢–µ—Å—Ç 3: –û—Ç–ø—Ä–∞–≤–∫–∞ SMS —á–µ—Ä–µ–∑ SMS.ru</h2>
            <div class="test-item" id="test-sms">
                <div class="test-name">–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ SMS –∫–æ–¥–∞</div>
                <span class="test-status status-pending">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                <div class="test-result" id="result-sms">–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"</div>
            </div>
        </div>

        <div class="section">
            <h2>üîê –¢–µ—Å—Ç 4: SMS –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª)</h2>
            <div class="test-item" id="test-auth">
                <div class="test-name">–ó–∞–ø—Ä–æ—Å SMS –∫–æ–¥–∞ ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞</div>
                <span class="test-status status-pending">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                <div class="test-result" id="result-auth">–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"</div>
            </div>
        </div>

        <div class="section">
            <h2>üìä –¢–µ—Å—Ç 5: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞</h2>
            <div class="test-item" id="test-data">
                <div class="test-name">–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ AmoCRM</div>
                <span class="test-status status-pending">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                <div class="test-result" id="result-data">–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://functions.poehali.dev/0c680166-1e97-4c5e-8c8f-5f2cd1c88850';
        
        let stats = { total: 5, passed: 0, failed: 0 };

        function updateSummary() {
            document.getElementById('totalTests').textContent = stats.total;
            document.getElementById('passedTests').textContent = stats.passed;
            document.getElementById('failedTests').textContent = stats.failed;
        }

        function setTestStatus(testId, status, result) {
            const testItem = document.getElementById(`test-${testId}`);
            const statusEl = testItem.querySelector('.test-status');
            const resultEl = document.getElementById(`result-${testId}`);

            statusEl.className = `test-status status-${status}`;
            statusEl.textContent = status === 'success' ? '‚úÖ –£—Å–ø–µ—à–Ω–æ' : 
                                   status === 'error' ? '‚ùå –û—à–∏–±–∫–∞' : '‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
            
            resultEl.textContent = typeof result === 'object' ? JSON.stringify(result, null, 2) : result;

            if (status === 'success') stats.passed++;
            if (status === 'error') stats.failed++;
            updateSummary();
        }

        async function testOAuth() {
            setTestStatus('oauth', 'pending', '–ü—Ä–æ–≤–µ—Ä–∫–∞ OAuth —Ç–æ–∫–µ–Ω–æ–≤...');
            try {
                const response = await fetch(`${API_URL}?phone=79991234567`);
                const data = await response.json();
                
                if (response.status === 500 && data.error?.includes('access token')) {
                    setTestStatus('oauth', 'error', `‚ùå –û—à–∏–±–∫–∞ OAuth:\n${data.error}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã:\n- AMOCRM_REFRESH_TOKEN\n- AMOCRM_CLIENT_ID\n- AMOCRM_CLIENT_SECRET\n- AMOCRM_DOMAIN\n- AMOCRM_REDIRECT_URI`);
                    return false;
                }
                
                setTestStatus('oauth', 'success', '‚úÖ OAuth —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ\nAccess token –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                return true;
            } catch (err) {
                setTestStatus('oauth', 'error', `–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${err.message}`);
                return false;
            }
        }

        async function testContactSearch() {
            const phone = document.getElementById('testPhone').value.replace(/\D/g, '');
            setTestStatus('contact', 'pending', '–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞...');
            
            try {
                const response = await fetch(`${API_URL}?phone=${phone}`);
                const data = await response.json();
                
                if (response.status === 404) {
                    setTestStatus('contact', 'error', `‚ùå –ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω\n–¢–µ–ª–µ—Ñ–æ–Ω ${phone} –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ AmoCRM\n\n–î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä`);
                    return false;
                }
                
                if (!response.ok) {
                    setTestStatus('contact', 'error', data.error || '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
                    return false;
                }
                
                setTestStatus('contact', 'success', `‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç –Ω–∞–π–¥–µ–Ω:\n–ò–º—è: ${data.name}\nID: ${data.id}\n–°–¥–µ–ª–æ–∫: ${data.leads?.length || 0}`);
                return true;
            } catch (err) {
                setTestStatus('contact', 'error', `–û—à–∏–±–∫–∞: ${err.message}`);
                return false;
            }
        }

        async function testSMS() {
            const phone = document.getElementById('testPhone').value.replace(/\D/g, '');
            setTestStatus('sms', 'pending', '–û—Ç–ø—Ä–∞–≤–∫–∞ SMS...');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'request-sms', phone })
                });
                
                const data = await response.json();
                
                if (response.status === 404) {
                    setTestStatus('sms', 'error', `‚ùå –¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ AmoCRM\n–î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç —Å –Ω–æ–º–µ—Ä–æ–º ${phone}`);
                    return false;
                }
                
                if (!response.ok) {
                    setTestStatus('sms', 'error', data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS');
                    return false;
                }
                
                if (!data.sms_sent && data.code) {
                    setTestStatus('sms', 'success', `‚ö†Ô∏è SMS –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (SMSRU_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)\n\n–ö–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–∞: ${data.code}\n\n–ù–∞—Å—Ç—Ä–æ–π—Ç–µ SMSRU_API_KEY –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS`);
                    return data.code;
                }
                
                setTestStatus('sms', 'success', '‚úÖ SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω');
                return true;
            } catch (err) {
                setTestStatus('sms', 'error', `–û—à–∏–±–∫–∞: ${err.message}`);
                return false;
            }
        }

        async function testAuth() {
            const phone = document.getElementById('testPhone').value.replace(/\D/g, '');
            setTestStatus('auth', 'pending', '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
            
            try {
                // –ó–∞–ø—Ä–æ—Å SMS
                const smsResponse = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'request-sms', phone })
                });
                
                const smsData = await smsResponse.json();
                
                if (!smsResponse.ok) {
                    setTestStatus('auth', 'error', `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ SMS: ${smsData.error}`);
                    return false;
                }
                
                const testCode = smsData.code || '1234';
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
                const verifyResponse = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'verify-sms', phone, code: testCode })
                });
                
                const verifyData = await verifyResponse.json();
                
                if (!verifyResponse.ok) {
                    setTestStatus('auth', 'error', `–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞: ${verifyData.error}`);
                    return false;
                }
                
                setTestStatus('auth', 'success', `‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!\n\n1. –ó–∞–ø—Ä–æ—Å SMS: ‚úÖ\n2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞: ‚úÖ\n3. –ü–æ–ª—É—á–µ–Ω –¥–æ—Å—Ç—É–ø –∫: ${verifyData.name}\n\n–ö–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–∞: ${testCode}`);
                return true;
            } catch (err) {
                setTestStatus('auth', 'error', `–û—à–∏–±–∫–∞: ${err.message}`);
                return false;
            }
        }

        async function testDataLoading() {
            const phone = document.getElementById('testPhone').value.replace(/\D/g, '');
            setTestStatus('data', 'pending', '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞...');
            
            try {
                const response = await fetch(`${API_URL}?phone=${phone}`);
                const data = await response.json();
                
                if (!response.ok) {
                    setTestStatus('data', 'error', data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                    return false;
                }
                
                const summary = {
                    name: data.name,
                    phone: data.phone,
                    leads: data.leads?.length || 0,
                    leadsList: data.leads?.map(l => `${l.name} (${l.price}‚ÇΩ)`) || []
                };
                
                setTestStatus('data', 'success', `‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:\n\n${JSON.stringify(summary, null, 2)}`);
                return true;
            } catch (err) {
                setTestStatus('data', 'error', `–û—à–∏–±–∫–∞: ${err.message}`);
                return false;
            }
        }

        async function runAllTests() {
            stats = { total: 5, passed: 0, failed: 0 };
            updateSummary();
            
            const oauthOk = await testOAuth();
            if (!oauthOk) {
                setTestStatus('contact', 'error', '–ü—Ä–æ–ø—É—â–µ–Ω–æ: OAuth –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                setTestStatus('sms', 'error', '–ü—Ä–æ–ø—É—â–µ–Ω–æ: OAuth –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                setTestStatus('auth', 'error', '–ü—Ä–æ–ø—É—â–µ–Ω–æ: OAuth –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                setTestStatus('data', 'error', '–ü—Ä–æ–ø—É—â–µ–Ω–æ: OAuth –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
                stats.failed += 4;
                updateSummary();
                return;
            }
            
            await new Promise(r => setTimeout(r, 500));
            await testContactSearch();
            
            await new Promise(r => setTimeout(r, 500));
            await testSMS();
            
            await new Promise(r => setTimeout(r, 500));
            await testAuth();
            
            await new Promise(r => setTimeout(r, 500));
            await testDataLoading();
        }

        updateSummary();
    </script>
</body>
</html>
